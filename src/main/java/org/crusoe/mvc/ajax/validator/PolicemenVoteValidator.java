package org.crusoe.mvc.ajax.validator;

import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.activiti.engine.FormService;
import org.activiti.engine.HistoryService;
import org.activiti.engine.IdentityService;
import org.activiti.engine.ProcessEngine;
import org.activiti.engine.RepositoryService;
import org.activiti.engine.RuntimeService;
import org.activiti.engine.TaskService;
import org.activiti.engine.history.HistoricProcessInstance;
import org.activiti.engine.history.HistoricTaskInstance;
import org.activiti.engine.history.HistoricVariableInstance;
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.subject.Subject;
import org.crusoe.service.AccountService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.google.common.collect.Lists;

@Controller
@RequestMapping(value = "/policemenVote")
public class PolicemenVoteValidator {

	@Autowired
	private RepositoryService repositoryService;
	@Autowired
	private RuntimeService runtimeService;
	@Autowired
	private ProcessEngine processEngine;
	@Autowired
	private FormService formService;
	@Autowired
	private IdentityService identityService;
	@Autowired
	private TaskService taskService;
	@Autowired
	private HistoryService historyService;

	@Autowired
	protected AccountService accountService;

	private static String[] pns = { "067001", "067002", "067003", "067004",
			"067006", "067007", "067008", "067009", "067010", "067555",
			"067018", "067005", "067017", "067292", "067619", "067286",
			"067587", "067576", "067026", "067692", "067073", "061901",
			"067108", "067118", "067035", "067868", "067586", "067704",
			"067195", "067850", "067914", "067978", "061937", "061950",
			"067081", "067893", "067092", "067689", "067061", "067238",
			"067988", "067396", "067537", "067099", "067123", "067341",
			"067658", "067264", "067223", "067260", "067722", "067639",
			"067046", "067193", "067470", "067307", "067365", "067032",
			"067024", "067079", "067475", "067127", "067848", "067111",
			"067239", "067566", "067034", "067036", "067052", "067466",
			"067645", "067177", "067331", "067647", "067338", "067930",
			"061911", "067562", "067217", "067112", "067065", "067593",
			"067358", "067462", "067864", "067345", "067862", "067653",
			"067071", "067637", "067889", "067866", "067979", "067149",
			"067861", "061943", "067196", "067641", "067143", "067551",
			"067578", "067597", "067903", "067178", "067828", "067571",
			"067103", "067095", "067553", "067382", "067261", "067133",
			"061929", "067610", "067966", "067965", "067935", "067929",
			"067928", "067538", "067570", "067557", "067356", "067871",
			"067548", "067197", "067545", "067352", "067084", "067933",
			"067507", "067583", "067927", "067940", "067794", "067602",
			"067595", "067620", "067582", "067860", "067895", "067854",
			"067781", "067665", "067606", "067096", "067546", "067883",
			"067909", "067910", "067564", "067563", "067859", "061949",
			"067219", "067951", "067561", "067663", "067659", "067480",
			"067791", "067477", "067849", "067972", "061939", "067667",
			"061977", "061988", "061989", "061982", "067526", "061925",
			"067266", "067912", "067863", "067672", "067552", "061912",
			"067585", "067265", "061946", "061959", "067090", "067915",
			"067550", "067408", "067635", "067385", "067874", "061916",
			"067670", "067736", "061953", "061960", "067908", "067252",
			"067447", "067918", "067476", "067628", "067812", "067206",
			"067655", "067906", "067159", "061942", "061935", "061938",
			"061985", "061990", "061980", "067142", "067125", "067734",
			"067778", "067856", "067499", "067380", "067171", "067638",
			"067784", "067770", "067822", "067708", "067753", "067344",
			"067119", "067201", "067246", "067469", "067430", "067448",
			"067427", "067397", "067128", "067176", "067916", "067387",
			"067191", "067549", "067276", "067917", "067050", "067089",
			"067625", "067087", "067091", "067228", "061999", "067491",
			"067710", "067021", "067668", "067626", "067656", "067688",
			"067773", "067646", "067685", "067417", "067290", "067705",
			"067648", "067048", "067662", "067381", "067732", "067719",
			"067651", "067076", "067669", "067699", "067298", "067869",
			"067742", "067740", "067599", "067700", "067330", "067666",
			"067615", "067497", "067591", "067185", "067422", "067042",
			"067679", "067678", "067690", "067231", "067744", "067697",
			"067066", "067473", "067434", "067975", "067735", "067607",
			"067043", "067952", "067661", "067386", "067717", "067715",
			"067703", "067113", "067468", "067892", "067847", "067263",
			"067723", "067368", "067981", "061961", "061962", "067681",
			"061955", "067776", "067211", "061927", "067750", "067959",
			"067780", "067713", "067698", "067695", "067716", "067706",
			"067761", "067037", "067153", "067982", "067707", "061963",
			"067991", "067726", "067728", "067775", "067733", "067720",
			"067135", "067253", "061965", "067102", "067714", "067038",
			"067709", "067743", "067243", "067083", "067738", "067810",
			"067373", "067747", "067746", "067762", "067963", "067960",
			"067765", "067304", "067608", "067392", "067724", "067745",
			"067957", "067968", "067751", "067763", "067741", "067772",
			"067855", "067311", "067767", "067891", "067616", "067782",
			"067612", "067980", "067327", "061967", "067416", "061941",
			"067424", "067783", "067958", "067953", "067721", "067766",
			"067524", "067085", "067254", "067271", "067536", "067182",
			"067319", "067795", "067787", "067786", "067777", "067796",
			"067907", "067318", "067956", "067515", "067028", "067754",
			"067407", "067098", "067887", "061958", "067890", "067049",
			"067967", "067962", "067961", "067172", "067811", "067627",
			"067510", "067793", "067760", "067737", "067969", "067955",
			"067885", "067757", "067755", "067138", "067421", "067030",
			"067100", "067687", "067205", "067542", "067817", "067107",
			"067919", "067581", "067078", "067270", "067209", "067148",
			"067519", "067194", "067291", "067208", "067106", "067858",
			"067573", "067357", "061907", "067439", "067117", "067458",
			"067729", "061940", "061928", "061909", "067922", "067937",
			"067529", "067683", "067297", "067696", "067058", "067785",
			"067186", "067132", "067531", "067144", "067051", "067180",
			"067154", "067060", "067852", "067572", "061921", "067285",
			"067370", "061979", "067375", "067280", "067225", "067310",
			"067188", "067215", "067872", "067094", "067162", "067287",
			"067082", "067126", "067415", "067022", "067923", "067302",
			"067336", "067522", "067590", "067323", "067802", "067584",
			"061971", "067898", "067867", "067577", "067701", "067317",
			"067277", "067820", "067097", "067274", "067222", "067169",
			"067363", "067824", "067853", "067329", "067840", "067878",
			"067158", "067694", "067301", "067268", "067229", "067192",
			"067752", "067165", "067326", "067496", "067711", "067168",
			"067825", "067579", "067334", "067516", "067675", "067350",
			"061947", "061969", "067815", "067936", "067303", "067418",
			"067926", "067139", "067187", "067190", "067189", "067203",
			"067799", "067827", "067826", "067835", "067865", "067876",
			"067240", "067340", "067220", "067200", "067601", "067324",
			"067677", "067511", "067976", "067983", "067950", "067990",
			"061983", "061995", "061948", "061917", "067124", "067532",
			"067328", "067535", "067210", "067621", "067207", "067272",
			"067857", "061993", "067029", "067364", "067367", "067242",
			"067801", "067800", "067483", "067632", "067136", "067598",
			"067069", "067636", "067493", "067495", "067528", "067846",
			"061970", "067973", "067155", "067273", "067540", "067247",
			"067150", "067296", "067414", "061951", "061968", "067920",
			"061932", "067086", "061910", "067897", "067618", "067212",
			"067170", "067360", "067312", "067829", "067831", "067833",
			"067369", "067730", "067179", "061936", "061931", "067513",
			"061996", "067809", "067498", "061905", "061919", "067596",
			"067104", "067156", "067105", "067503", "067258", "067589",
			"067567", "067881", "067391", "067588", "061998", "067931",
			"061945", "067348", "067199", "067236", "067879", "067355",
			"067568", "067759", "067686", "067457", "061956", "067558",
			"067932", "067278", "067257", "067256", "067267", "067269",
			"067255", "067832", "067834", "067343", "067533", "067560",
			"067830", "067611", "067693", "067875", "067604", "067569",
			"067281", "067316", "067282", "067877", "067505", "067289",
			"067137", "067902", "067712", "067332", "067629", "067110",
			"067308", "067836", "067880", "067204", "067805", "067151",
			"067140", "067816", "067691", "067819", "067237", "067335",
			"067870", "067525", "067539", "067839", "061972", "067749",
			"067913", "067163", "067938", "067337", "067702", "067299",
			"067235", "067384", "067939", "067390", "067388", "067393",
			"067395", "067389", "067603", "067372", "067478", "067488",
			"067040", "067435", "067314", "067769", "067275", "067756",
			"067377", "067157", "067359", "067054", "067623", "067333",
			"067241", "067440", "067768", "067460", "067886", "067941",
			"067609", "067409", "067403", "067379", "067402", "067406",
			"067841", "067896", "067438", "067349", "067622", "067420",
			"067554", "067451", "067398", "067842", "067436", "061920",
			"061906", "067449", "067942", "067943", "067426", "067428",
			"067419", "067425", "067843", "067122", "067748", "067160",
			"067453", "067183", "067559", "067413", "061997", "067798",
			"067053", "067378", "061915", "067613", "067575", "067445",
			"067412", "067945", "067431", "067614", "067454", "067442",
			"067456", "067652", "067405", "067758", "067129", "067455",
			"067441", "067771", "067433", "067452", "067481", "067806",
			"067459", "067921", "067437", "067471", "067116", "067948",
			"067342", "067465", "067486", "067580", "067487", "067844",
			"067432", "067882", "067057", "067056", "067971", "067353",
			"067977", "061987", "061992", "061973", "061933", "067198",
			"067429", "067461", "067234", "067145", "067803", "067970",
			"067946", "067055", "067259", "067500", "067484", "067813",
			"067901", "067900", "067523", "067506", "067492", "061981",
			"061991", "067202", "061976", "067068", "067520", "061918",
			"067947", "067479", "067218", "067362", "067494", "067633",
			"067489", "067530", "067821", "067565", "067814", "067797",
			"067617", "061952", "067167", "067463", "067346", "067399",
			"067600", "067279", "067175", "067446", "067141", "067502",
			"067808", "067851", "067120", "067075", "067725", "067361",
			"067262", "061986", "067682", "067354", "061923", "067634",
			"067640", "067631", "067949", "067823", "067490", "067501",
			"067630", "067521", "067512", "067676" };
	static List pnsList = Arrays.asList(pns);

	@RequestMapping(value = "validator/{processDefinitionId}", method = RequestMethod.POST)
	public @ResponseBody
	HashMap<String, Object> validateForm(
			@PathVariable String processDefinitionId,
			@RequestParam("policemanNumber") String policemanNumber,
			HttpServletRequest request, HttpServletResponse response) {
		HashMap<String, Object> rets = new HashMap<String, Object>();

		if (!pnsList.contains(policemanNumber)) {

			rets.put("err", true);
			rets.put("msg", "警号有误，无法投票！");
			return rets;

		}

		List<HistoricProcessInstance> processes = historyService
				.createHistoricProcessInstanceQuery()
				.processDefinitionId(processDefinitionId).list();

		for (HistoricProcessInstance process : processes) {
			List<HistoricVariableInstance> variables = historyService
					.createHistoricVariableInstanceQuery()
					.processInstanceId(process.getId()).list();
			for (HistoricVariableInstance variable : variables) {
				if (variable.getVariableName().equals("policemanNumber")) {

					if (variable.getValue().equals(policemanNumber)) {
						rets.put("err", true);
						rets.put("msg", "您已经投过票了！");
						return rets;

					}

				}

			}
		}
		rets.put("err", false);
		rets.put("msg", "UnVoted");
		return rets;
	}
}
