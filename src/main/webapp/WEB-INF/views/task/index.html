<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns:th="http://www.thymeleaf.org">
<head thy:merge="/common::headerFragment">
<title>任务列表</title>
<style>
.hover {
	background-color: #cccc00;
}
</style>
</head>
<body>
	<div class="col-xs-12">
		<div class="table-responsive" id="listView">
			<table id="taskList" cellpadding="0" cellspacing="0" border="0"
				class="table table-striped table-bordered table-hover">
				<thead>
					<tr>
						<th><input type="checkbox" id="checkAll" value="" /></th>
						<th>序号</th>
						<th>名称</th>
						<th>发起者</th>
						<th>所在部门</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			<div>
				<ul id="paginatorForTaskList"></ul>
			</div>
			<button id="deleteTaskBtn" class="btn btn-danger">
				<i class="icon-trash bigger-110"></i>删除选中
			</button>
		</div>
	</div>
	<div id="view"></div>

	<div class="modal fade" id="dialog-message" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true"
		data-backdrop="static">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span><span class="sr-only">X</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">消息</h4>
				</div>
				<div class="modal-body">
					<p>你真的要删除吗?</p>
				</div>
				<div class="modal-footer">
					<button class="btn btn-danger" type="button" data-dismiss="modal"
						id="yes">是</button>
					<button class="btn btn-primary" type="button" data-dismiss="modal"
						id="no">否</button>
				</div>
			</div>
		</div>
	</div>
	<div th:replace="/common::javascriptFragment"></div>
	<script type="text/javascript" th:inline="javascript">
		/*<![CDATA[*/
		function render(data) {
			var newRow = "<tr><td><input type=\"checkbox\" name=\"selectFlag\" value=\""+data.id+"\"/></td><td>"
					+ data.id
					+ "</td><td>"
					+ data.name
					+ "</td><td>"
					+ data.initiatorUser.name
					+ "</td><td>"
					+ getOrganization(data.initiatorUser.organizationId)
					+ "</td><td><a href=\"javascript:loadView('"
					+ /*[[@{'/runtime/tasks/claim/'}]]*/"1234/" //url
					+ data.id + "')\">办理</a></td></tr>";
			return newRow;
		};
		function getOrganization(organizationId) {
			var organizationName;
			$.ajax({
				type : 'GET',
				url : /*[[@{'/organization/'}]]*/''//load organization  
						+ organizationId,
				async : false,
				success : function(data) {
					organizationName = data.text;
				}
			});
			return organizationName;

		};
		var browserDetectUri = /*[[@{'/assets/js/browserDetect.js'}]]*/'/assets/js/browserDetect.js';
		require(
				[ browserDetectUri ],
				function($) {

					$('#checkAll').bind('click', function() {
						checkAll("#checkAll");
					});
					$('#yes').bind(
							'click',
							function() {
								batchDelete(
								/*[[@{'/runtime/tasks/'}]]*/"/runtime/tasks",
										successCallback);
								$("#dialog-message").modal('hide');

							});
					$('#no').bind('click', function() {

						$("#dialog-message").modal('hide');

					});

					$('#deleteTaskBtn').bind('click', function() {
						$("#dialog-message").modal();

					});

					$("#taskList")
							.simpleTable(
									/*[[@{'/runtime/tasks/listTasks?sort=name&order=desc&beforeDate='+${beforeDate}+'&afterDate='+${afterDate}}]]*/""
											+ "&timestamp="
											+ new Date().toString(), render,
									$("#paginatorForTaskList"), updateBadge);

				});

		function successCallback() {

			$("#taskList tbody tr").remove();

			$("#taskList")
					.simpleTable(
							/*[[@{'/runtime/tasks/listTasks?sort=name&order=desc&beforeDate='+${beforeDate}+'&afterDate='+${afterDate}}]]*/""
									+ "&timestamp=" + new Date().toString(),
							render, $("#paginatorForTaskList"), updateBadge);

		};

		function updateBadge(count, start, size) {
			$("#listView").trigger("evtTasksBadge", {
				badges : count
			});

		};
		function loadView(url) {
			$("#view")
					.load(
							url + '?' + (new Date()).valueOf(),
							function(data) {
								$("#view")
										.bind(
												"evtWFSuccess",
												function(evt, data) {
													$("#view").hide();
													$("#taskList")
															.clearSimpleTable();
													$("#listView").show();
													$("#taskList")
															.simpleTable(
																	/*[[@{'/runtime/tasks/listTasks?sort=name&order=desc&beforeDate='+${beforeDate}+'&afterDate='+${afterDate}}]]*/"",
																	render,
																	$("#paginatorForTaskList"),
																	updateBadge);

												});
								$("#view").show();
								$("#listView").hide();

							});
		};
		/*]]>*/
	</script>
</body>
</html>
